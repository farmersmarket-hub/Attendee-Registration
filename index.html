<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendee Registration Form</title>
	<!-- Choices.js CDN -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #84fab0, #8fd3f4);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            width: 65%;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            background: linear-gradient(135deg, #ffffff, #e3f2fd);
        }
        h2 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        label::after {
            content: " *";
            color: red;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 16px;
        }
        button {
            width: 100%;
            background: linear-gradient(135deg, #ff7eb3, #ff758c);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s;
        }
        button:hover {
            background: linear-gradient(135deg, #ff758c, #ff7eb3);
            transform: scale(1.05);
        }
		.success-message {
            display: none;
            margin-top: 20px;
            padding: 10px;
            background: #28a745;
            color: white;
            text-align: center;
            border-radius: 5px;
        }
		.hidden { display: none; }
		.choices__inner {
		  min-height: 42px !important;
		  padding: 6px 10px !important;
		  font-size: 14px !important;
		  border: 1px solid #cbd5e0 !important;
		  border-radius: 8px !important;
		  background-color: #f9fafb !important;
		  display: flex !important;
		  flex-wrap: wrap !important;
		  align-items: center !important;
		  gap: 6px !important;
		}
		.choices__list--multiple .choices__item {
		  display: inline-flex !important;
		  align-items: center !important;
		  background-color: #0f6674 !important;
		  color: white !important;
		  font-weight: 600 !important;
		  font-size: 13px !important;
		  border-radius: 9999px !important;
		  padding: 4px 10px !important;
		  line-height: 1.2 !important;
		  margin: 2px 2px !important;
		  white-space: nowrap !important;
		}
		.choices__list--multiple .choices__item .choices__button {
		  margin-left: 6px !important;
		  color: white !important;
		  opacity: 0.8 !important;
		  font-size: 14px !important;
		}
		.choices__input {
		  font-size: 14px !important;
		  padding: 6px 4px !important;
		  margin: 2px 0 !important;
		  min-width: 150px !important;
		  border: none !important;
		  outline: none !important;
		  background: transparent !important;
		  color: #333;
		}
		.choices__list--dropdown .choices__item--selectable {
		  padding: 8px 12px !important;
		  font-size: 14px !important;
		}
		.choices__item--selectable.is-highlighted {
		  background-color: #edf2f7 !important;
		}
		.tooltip {
		  position: relative;
		  display: inline-block;
		  margin-left: 6px;
		  width: 18px;
		  height: 18px;
		  background-color: #007bff;
		  color: white;
		  font-size: 12px;
		  text-align: center;
		  border-radius: 50%;
		  font-weight: bold;
		  cursor: pointer;
		  line-height: 18px;
		}
		.tooltip .tooltiptext {
		  visibility: hidden;
		  width: 180px;
		  background-color: #333;
		  color: #fff;
		  text-align: center;
		  border-radius: 5px;
		  padding: 6px;
		  position: absolute;
		  z-index: 1;
		  top: -5px;
		  left: 110%;
		  opacity: 0;
		  transition: opacity 0.3s ease;
		}
		.tooltip:hover .tooltiptext {
		  visibility: visible;
		  opacity: 1;
		}
		.hint-text {
		  display: block;
		  font-size: 13px;
		  color: #6b7280; /* a soft gray, similar to Tailwind's gray-600 */
		  margin-top: 4px;
		}
		.no-global-star::after {
		  content: none !important;
		}
		.label-required .main-label::after {
		  content: " *";
		  color: red;
		  font-weight: bold;
		}

    </style>
	
</head>
<body>
    <div class="container" >
		<div id="successMessage" class="success-message"></div>
        <h2>Attendee Registration Form</h2>
        <form id="registrationForm" onsubmit="generateNeighborId(event)">
			<div class="form-group">
                <label for="date">Today's Date</label>
                <input type="date" id="todayDate" name="todayDate" readonly>
            </div>
            <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" required oninput="validateInput(event, /^[A-Za-z\s]*$/)" data-error="Only alphabets are allowed.">
            </div>
            <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" required oninput="validateInput(event, /^[A-Za-z\s]*$/)" data-error="Only alphabets are allowed.">
            </div>
            <div class="form-group">
                <label for="age" class="no-global-star">Date of Birth</label>
                <input type="date" id="dob" name="dob" >
            </div>
            <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender" required>
                    <option value="">- Select Gender -</option>
                    <option value="Female">Female</option>
                    <option value="Male">Male</option>
                    <option value="Non-binary">Non-binary</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="race">Race/Ethnicity</label>
                <select id="race" name="race" required>
                    <option value="">- Select Race -</option>
                    <option value="African/African-American/Black">African/African-American/Black</option>
                    <option value="American Indian/Alaskan Native/Indigenous American">American Indian/Alaskan Native/Indigenous American</option>
                    <option value="Caucasian/European/European-American/White">Caucasian/European/European-American/White</option>
                    <option value="South Asian/South Asian-American">South Asian/South Asian-American</option>
			<option value="East Asian/East Asian-American">East Asian/East Asian-American</option>
                    <option value="Latine (Latino/a/x) or Hispanic">Latine (Latino/a/x) or Hispanic</option>
					<option value="Native Hawaiian/Pacific Islander">Native Hawaiian/Pacific Islander</option>
			<option value="Other">Other</option>
                </select>
				<div id="otherRaceDiv" class="hidden">
					<label for="otherRace">Please specify </label>
					<input type="text" id="otherRace" name="otherRace" placeholder="Enter other race">
				</div>
            </div>
			<div class="form-group">
                <label for="nationality">Nationality</label>
		<span class="hint-text">(Type the nationality name to search for it in the list. You can add multiple nationalities.)</span>
                <select id="nationality" name="nationality" multiple required>
					<option value="U.S.">U.S.</option>
					<option value="Japanese">Japanese</option>
					<option value="Chinese">Chinese</option>
					<option value="Korean">Korean</option>
					<option value="Vietnamese">Vietnamese</option>
					<option value="Other East Asian">Other East Asian</option>
					<option value="Indian">Indian</option>
					<option value="Pakistani">Pakistani</option>
					<option value="Sri Lankan">Sri Lankan</option>
					<option value="Burmese">Burmese</option>
					<option value="Cambodian">Cambodian</option>
					<option value="Other South or Southeast Asian">Other South or Southeast Asian</option>
					<option value="Ethiopian">Ethiopian</option>
					<option value="Eritrean">Eritrean</option>
					<option value="Somali">Somali</option>
					<option value="Other East African">Other East African</option>
					<option value="Liberian">Liberian</option>
					<option value="Nigerian">Nigerian</option>
					<option value="Ghanaian">Ghanaian</option>
					<option value="Congolese">Congolese</option>
					<option value="Cameroonian">Cameroonian</option>
					<option value="Other West, Central or North African">Other West, Central or North African</option>
					<option value="Middle Eastern">Middle Eastern</option>
					<option value="Mexican">Mexican</option>
					<option value="Central American">Central American</option>
					<option value="South American">South American</option>
					<option value="Caribbean Island">Caribbean Island</option>
					<option value="Pacific Islander">Pacific Islander</option>
					<option value="Ukrainian">Ukrainian</option>
					<option value="Russian">Russian</option>
					<option value="Other European">Other European</option>
					<option value="Other">Other</option>
				</select>
				<div id="otherNationalityDiv" class="hidden">
					<label for="otherNationality">Please specify </label>
					<input type="text" id="otherNationality" name="otherNationality" placeholder="Enter other nationality">
				</div>
			</div>
            <div class="form-group">
                <label for="address">Address</label>
                <input type="text" id="address" name="address" required>
            </div>
			<div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" required>
            </div>
			<div class="form-group">
                <label for="state">State</label>
                <select id="state" name="state" required>
					<option value="">- Select a state -</option>
					<option value="AL">AL</option>
					<option value="AK">AK</option>
					<option value="AZ">AZ</option>
					<option value="AR">AR</option>
					<option value="CA">CA</option>
					<option value="CO">CO</option>
					<option value="CT">CT</option>
					<option value="DE">DE</option>
					<option value="DC">DC</option>
					<option value="FL">FL</option>
					<option value="GA">GA</option>
					<option value="HI">HI</option>
					<option value="ID">ID</option>
					<option value="IL">IL</option>
					<option value="IN">IN</option>
					<option value="IA">IA</option>
					<option value="KS">KS</option>
					<option value="KY">KY</option>
					<option value="LA">LA</option>
					<option value="ME">ME</option>
					<option value="MD">MD</option>
					<option value="MA">MA</option>
					<option value="MI">MI</option>
					<option value="MN">MN</option>
					<option value="MS">MS</option>
					<option value="MO">MO</option>
					<option value="MT">MT</option>
					<option value="NE">NE</option>
					<option value="NV">NV</option>
					<option value="NH">NH</option>
					<option value="NJ">NJ</option>
					<option value="NM">NM</option>
					<option value="NY">NY</option>
					<option value="NC">NC</option>
					<option value="ND">ND</option>
					<option value="OH">OH</option>
					<option value="OK">OK</option>
					<option value="OR">OR</option>
					<option value="PA">PA</option>
					<option value="RI">RI</option>
					<option value="SC">SC</option>
					<option value="SD">SD</option>
					<option value="TN">TN</option>
					<option value="TX">TX</option>
					<option value="UT">UT</option>
					<option value="VT">VT</option>
					<option value="VA">VA</option>
					<option value="WA">WA</option>
					<option value="WV">WV</option>
					<option value="WI">WI</option>
					<option value="WY">WY</option>
				</select>
            </div>
            <div class="form-group">
                <label for="zip">Zip Code</label>
                <input type="text" id="zip" name="zip" required oninput="validateInput(event, /^\d{5}(-\d{4})?$/)" data-error="Enter a valid zip code (e.g., 12345 or 12345-6789).">
            </div>
			<div class="form-group">
                <label for="email" class="no-global-star">Email Address</label>
                <input type="email" id="email" name="email">
            </div>
			<div class="form-group">
                <label for="contact">Contact Phone Number</label>
                <input type="text" id="contact" name="contact" required>
            </div>
			<div class="form-group">
                <label for="regType">Are you registering as an Individual or a Family?</label>
                <select id="regType" name="regType" required>
                    <option value="">- Select -</option>
                    <option value="Individual">Individual</option>
                    <option value="Family">Family</option>
                </select>
            </div>
            <div class="form-group">
			  <label for="householdSize">Household Size</label>
			  <input type="number" id="householdSize" name="householdSize" required min="1">
			</div>

			<!-- Collapsible family section -->
			<div class="form-group">
				<div id="familySection" style="display: none; margin-top: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px;">
				  <h4 style="margin-bottom: 10px; cursor: pointer;" onclick="toggleFamilySection()">
					Other Household Members <span id="toggleArrow">▼</span>
				  </h4>
				  <div id="familyMembersWrapper" style="max-height: 500px; overflow-y: auto; transition: max-height 0.3s ease;">
					<div id="familyMembersContainer"></div>
				  </div>
				</div>
			</div>
            <div class="form-group">
                <label for="engLang">Is English your first or primary language?</label>
                <select id="engLang" name="engLang" required>
                    <option value="">- Select -</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
		<div class="form-group">
                <label for="otherLang" class="no-global-star">Do you speak any other languages? If so, select all that apply</label>
		<input list="languageOptions" name="otherLang" id="otherLang">
	                <datalist id="languageOptions">
			  <option value="No other languages spoken">
			  <option value="Spanish">
			  <option value="Chinese">
			  <option value="Tagalog">
			  <option value="Vietnamese">
			  <option value="Arabic">
			  <option value="French">
			  <option value="Haitian Creole">
			  <option value="Korean">
			  <option value="Russian">
			  <option value="Portuguese">
			  <option value="Japanese">
			  <option value="German">
			  <option value="Somali">
			  <option value="Swahili">
			  <option value="Amharic">
			  <option value="Oromo">
			  <option value="Hindi">
			  <option value="Urdu">
			  <option value="Punjabi">
			  <option value="Nepali">
			  <option value="Bengali">
			  <option value="Burmese">
			  <option value="Karen">
			  <option value="Rohingya">
			  <option value="Navajo">
			  <option value="Cherokee">
			</datalist>
            </div>
			<div class="form-group">
                <label for="reachProgram">Which program or event is this registration associated with?</label>
                <select id="reachProgram" name="reachProgram" onchange="toggleOtherReachProgram()" required>
					<option value="">- Select -</option>
                    <option value="00">Unknown</option>
                    <option value="01">None</option>
                    <option value="10">PGL-REACH Farmers Market</option>
                    <option value="20">Other</option>
                </select>
            </div>
		<div class="form-group hidden" id="otherReachProgramDiv">
                <label>Please Specify</label>
                <input type="text" name="otherReachProgram" id="otherReachProgram" placeholder="Enter Other REACH Program">
            </div>
            <div class="form-group">
                <label for="registeringVendor">How did you hear about the People's Market?</label>
                <select id="registeringVendor" name="registeringVendor" required>
					<option value="">- Select -</option>
                    <option value="000">Instagram</option>
                    <option value="100">Facebook</option>
                    <option value="200">Other Social Media</option>
                    <option value="300">REACH</option>
                    <option value="400">ACHIEVE Coalition</option>
                    <option value="500">PGL Event</option>
                    <option value="600">A Current Market Vendor</option>
		    <option value="700">Other Word of Mouth</option>
		    <option value="800">I attended Last Year</option>
		    <option value="900">Other</option>
                </select>
            </div>
			<div class="form-group">
                <label for="reachPopulation">Does any of the following categories apply to the attendee or their household?</label>
                <select id="reachPopulation" name="reachPopulation" multiple required>
                    <option value="">- Select -</option>
                    <option value="0000">Unknown</option>
                    <option value="0100">None</option>
                    <option value="1000">Low-income</option>
                    <option value="2000">Immigrant</option>
                    <option value="3000">Older Adult (65+)</option>
                    <option value="4000">Unemployed</option>
                    <option value="5000">No H.S diploma or equivalent</option>
                    <option value="6000">Single-parent headed household</option>
                    <option value="7000">Grandparent-headed household</option>
                    <option value="8000">Person with disabilities</option>
                    <option value="9000">Food insecure</option>
                    <option value="9999">Other</option>
                </select>
				<div class="hidden" id="otherReachPopulationDiv">
                <label>Please Specify</label>
                <input type="text" name="otherReachPopulation" id="otherReachPopulation" placeholder="Enter Other Category">
            </div>
            </div>

	    <div class="form-group">
                <label for="lastYearAttendance">Did you or anyone from your household attend this market last year?</label>
                <select id="lastYearAttendance" name="lastYearAttendance" required>
                    <option value="">- Select -</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
		
            <div class="form-group">
                <label for="csaRecipient">Are you currently enrolled as a PGL CSA recipient?</label>
                <select id="csaRecipient" name="csaRecipient" required>
                    <option value="">- Select -</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
			<option value="Not yet - approved for today">Not yet - approved for today</option>
                </select>
            </div>
			<div class="form-group">
                <label for="programs">Are you/your family enrolled in any of the following programs?</label>
				<label for="snap">SNAP</label>
                <select id="snap" name="snap" onchange="toggleSnapAmount()" required>
                    <option value="">- Select -</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
			<div class="form-group hidden" id="snapAmountDiv">
	                <label>If Yes, Amount</label>
	                <input type="text" name="snapAmount" id="snapAmount" class="currency-input" title="Enter amount in format: $000.00" oninput="validateCurrencyInput(this)" onblur="formatCurrency(this)" onchange="fillSnapPlusBucks()" data-error="Enter amount in format: $000.00">
			<input type="text" name="snapPlusAmount" id="snapPlusAmount" class="currency-input hidden">
			<input type="text" name="snapTokensAmount" id="snapTokens" class="hidden">
			</div>
			<div class="form-group hidden" id="snapCodeDiv">
			<label>Also, Enter the last 4 digits of your SNAP number</label>
                	<input type="text" name="snapCode" id="snapCode" >
			</div>
				<label for="wallace">Wallace Clinic</label>
                <select id="wallace" name="wallace" onchange="toggleWallaceAmount()" required>
                    <option value="">- Select -</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
				<div class="form-group hidden" id="wallaceCodeDiv">
                <label>Verification completed?</label>
                <select name="wallaceCode" id="wallaceCode">
			<option value="">-Select-</option>
			<option value="Yes">Yes</option>
			<option value="No">No</option>
		</select>
            </div>
				<div class="form-group hidden" id="wallaceAmountDiv">
                <label>If Yes, Amount</label>
                <input type="text" name="wallaceAmount" id="wallaceAmount" readonly>
            </div>
				<label for="ofb">Community Bucks</label>
                <select id="ofb" name="ofb" onchange="toggleOFBAmount()" required>
                    <option value="">- Select -</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
		<div class="form-group hidden" id="ofbAmountDiv">
	                <label>If Yes, Amount</label>
	                <input type="text" name="ofbAmount" id="ofbAmount" class="currency-input" title="Enter amount in format: $000.00" oninput="validateCurrencyInput(this)" onblur="formatCurrency(this)" data-error="Enter amount in format: $000.00">
            	</div>
            </div>
			<div class="form-group">
				<label for="pglBucks" class="label-required no-global-star">
				<span class="main-label">Did you bring any PGL Bucks?</span>
				<span class="hint-text">(Yes, only if you currently have bucks in hand to use)</span>
				</label>
                <select id="pglBucks" name="pglBucks" onchange="togglePGLAmount()" required>
                    <option value="">- Select -</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
			<div class="form-group hidden" id="pglAmountDiv">
                <label>If Yes, Amount</label>
                <input type="text" name="pglAmount" id="pglAmount" class="currency-input" title="Enter amount in format: $000.00" oninput="validateCurrencyInput(this)" onblur="formatCurrency(this)" data-error="Enter amount in format: $000.00">
            </div>
		<div class="form-group">
		<label for="comments" class="no-global-star">Additional Notes or Comments</label>
                <textarea class="w-full p-2 border rounded bg-white" name="comments" id="comments" rows="3"></textarea>
		</div>
			<input type="hidden" name="neighborid" id="neighborid">
			<input type="hidden" name="attendeeId" id="attendeeId">
            <button type="submit">Register</button>
        </form>
    </div>
	
<script>
		document.getElementById('todayDate').valueAsDate = new Date();
		
		function toggleFamilySection() {
		  const wrapper = document.getElementById("familyMembersWrapper");
		  const arrow = document.getElementById("toggleArrow");
		  if (wrapper.style.display === "none") {
			wrapper.style.display = "block";
			arrow.textContent = "▼";
		  } else {
			wrapper.style.display = "none";
			arrow.textContent = "▲";
		  }
		}
		
		function togglePGLAmount() {
            const select = document.getElementById('pglBucks');
            const amountDiv = document.getElementById('pglAmountDiv');
			const amountInput = document.getElementById('pglAmount');
            amountDiv.classList.toggle('hidden', select.value === 'No');
			amountInput.required = (select.value === "Yes");
        }

	function toggleWallaceAmount() {
            const selectWallace = document.getElementById('wallace');
            const wallaceAmountDiv = document.getElementById('wallaceAmountDiv');
			const wallaceAmountInput = document.getElementById('wallaceAmount');
		const wallaceCodeDiv = document.getElementById('wallaceCodeDiv');
			const wallaceCodeInput = document.getElementById('wallaceCode');
            wallaceAmountDiv.classList.toggle('hidden', selectWallace.value === 'No');
			wallaceAmountInput.required = (selectWallace.value === "Yes");
		wallaceCodeDiv.classList.toggle('hidden', selectWallace.value === 'No');
			wallaceCodeInput.required = (selectWallace.value === "Yes");
		if (!wallaceAmountDiv.classList.contains('hidden')) {
		    wallaceAmountInput.value = "$25.00";
		} else {
		    wallaceAmountInput.value = "";
		}

        }

	function toggleSnapAmount() {
            const selectSnap = document.getElementById('snap');
            const snapAmountDiv = document.getElementById('snapAmountDiv');
			const snapAmountInput = document.getElementById('snapAmount');
		const snapCodeDiv = document.getElementById('snapCodeDiv');
			const snapCodeInput = document.getElementById('snapCode');
            snapAmountDiv.classList.toggle('hidden', selectSnap.value === 'No');
			snapAmountInput.required = (selectSnap.value === "Yes");
		snapCodeDiv.classList.toggle('hidden', selectSnap.value === 'No');
			snapCodeInput.required = (selectSnap.value === "Yes");

        }

	function toggleOFBAmount() {
            const selectOFB = document.getElementById('ofb');
            const ofbAmountDiv = document.getElementById('ofbAmountDiv');
			const ofbAmountInput = document.getElementById('ofbAmount');
            ofbAmountDiv.classList.toggle('hidden', selectOFB.value === 'No');
			ofbAmountInput.required = (selectOFB.value === "Yes");
        }

	function toggleOtherReachProgram() {
            const selectReachProgram = document.getElementById('reachProgram');
            const otherReachProgramDiv = document.getElementById('otherReachProgramDiv');
			const otherReachProgramInput = document.getElementById('otherReachProgram');
            otherReachProgramDiv.classList.toggle('hidden', selectReachProgram.value !== '20');
			otherReachProgramInput.required = (selectReachProgram.value === "20");
        }

	function validateCurrencyInput(input) {
			const value = input.value;
			const regex = /^\$\d{1,3}(\.\d{2})?$/;
			
			// If it's empty or doesn't match pattern, show custom error
			if (value && !regex.test(value)) {
			  input.setCustomValidity(input.getAttribute('data-error'));
			  input.reportValidity();  // Show error immediately
			} else {
			  input.setCustomValidity('');
			}
	    }

	    function formatCurrency(input) {
			// Allow plain numbers like 123.45 → $123.45
			const plainRegex = /^\d+(\.\d{1,2})?$/;
			const formattedRegex = /^\$\d+(\.\d{2})?$/;

			if (plainRegex.test(input.value)) {
			  let num = parseFloat(input.value).toFixed(2);
			  input.value = `$${num}`;
			}

			// Revalidate in case blur fixes format
			validateCurrencyInput(input);
	    }
		
		document.addEventListener('DOMContentLoaded', function () {
					new Choices('#nationality', {
						removeItemButton: true,
						placeholderValue: 'Select Nationality',
						searchPlaceholderValue: 'Type to search...',
						shouldSort: false
					});
					
					const otherDiv = document.getElementById('otherNationalityDiv');
					const otherInput = document.getElementById('otherNationality');

					document.querySelector('#nationality').addEventListener('change', function () {
						const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);
						if (selectedOptions.includes('Other')) {
							otherDiv.classList.remove('hidden');
							otherInput.required = true;
						} else {
							otherDiv.classList.add('hidden');
							otherInput.required = false;
						}
					});

					new Choices('#reachPopulation', {
						removeItemButton: true,
						placeholderValue: 'Select Category',
						searchPlaceholderValue: 'Type to search...',
						shouldSort: false
					});

					const otherReachPopulationDiv = document.getElementById('otherReachPopulationDiv');
					const otherReachPopulationInput = document.getElementById('otherReachPopulation');

					document.querySelector('#reachPopulation').addEventListener('change', function () {
						const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);
						if (selectedOptions.includes('9999')) {
							otherReachPopulationDiv.classList.remove('hidden');
							otherReachPopulationInput.required = true;
						} else {
							otherReachPopulationDiv.classList.add('hidden');
							otherReachPopulationInput.required = false;
						}
					});
					
					new Choices('#state', {
						searchEnabled: true,
						shouldSort: false
					});
				
					new Choices('#race', {
						searchEnabled: true,
						shouldSort: false
					});

					const otherRaceDiv = document.getElementById('otherRaceDiv');
					const otherRaceInput = document.getElementById('otherRace');

					document.querySelector('#race').addEventListener('change', function () {
						const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);
						if (selectedOptions.includes('Other')) {
							otherRaceDiv.classList.remove('hidden');
							otherRaceInput.required = true;
						} else {
							otherRaceDiv.classList.add('hidden');
							otherRaceInput.required = false;
						}
					});
				
					new Choices('#gender', {
						searchEnabled: true,
						shouldSort: false
					});

													
					const householdInput = document.getElementById("householdSize");
					const section = document.getElementById("familySection");
					const container = document.getElementById("familyMembersContainer");
					const wrapper = document.getElementById("familyMembersWrapper");

					householdInput.addEventListener("input", function () {
						const count = parseInt(this.value);
						container.innerHTML = "";

						if (count && count > 1) {
						  section.style.display = "block";
						  wrapper.style.display = "block";

						  for (let i = 1; i < count; i++) {
							const card = document.createElement("div");
							card.className = "member-card";
							card.style.cssText = `
							  border: 1px solid #ccc;
							  padding: 16px;
							  border-radius: 8px;
							  margin-bottom: 15px;
							  background: #f9f9f9;
							`;

							const badge = document.createElement("div");
							badge.textContent = `Member ${i} of ${count - 1}`;
							badge.style.cssText = `
							  background: #007bff;
							  color: white;
							  padding: 4px 10px;
							  font-size: 13px;
							  font-weight: bold;
							  border-radius: 20px;
							  display: inline-block;
							  margin-bottom: 10px;
							`;

							card.appendChild(badge);

							card.innerHTML += `
							  <div class="form-group">
								<label for="member${i}FirstName">First Name:</label>
								<input type="text" name="member${i}FirstName" id="member${i}FirstName" required>
							  </div>

							  <div class="form-group">
								<label for="member${i}LastName">Last Name:</label>
								<input type="text" name="member${i}LastName" id="member${i}LastName" required>
							  </div>

							  <div class="form-group">
								<label for="member${i}Dob" class="no-global-star">
								  Date of Birth:
								  <span class="tooltip">i
									<span class="tooltiptext">Member must be over the age of 10</span>
								  </span>
								</label>
								<input type="date" name="member${i}Dob" id="member${i}Dob"
								  oninvalid="this.setCustomValidity('Age must be at least 3')"
								  oninput="this.setCustomValidity('')">
							  </div>
							`;

							container.appendChild(card);
						  }
						} else {
						  section.style.display = "none";
						  wrapper.style.display = "none";
						}
					});
				});

	function parseDollar(val) {
	  if (!val) return 0;
	  const numeric = val.replace(/[^\d.-]/g, '');
	  return isNaN(parseFloat(numeric)) ? 0 : parseFloat(numeric);
	}

	function fillSnapPlusBucks() {
	  const snapTokens = document.getElementById('snapTokens');
	  const snapAmount = document.getElementById('snapAmount');
	  const snapPlusAmount = document.getElementById('snapPlusAmount');
	  
	  const snap = parseDollar((snapAmount.value));
	  snapPlusAmount.value = `$${(snap * 2).toFixed(2)}`;
	  snapTokens.value = parseInt(snap);
	}
	
        function validateInput(event, pattern) {
            let inputField = event.target;
            if (!pattern.test(inputField.value)) {
                inputField.setCustomValidity(inputField.getAttribute('data-error'));
            } else {
                inputField.setCustomValidity('');
            }
        }

	async function generateQRCodePDF(neighborId, attendeeId, formData) {
      const url = `https://farmersmarket-hub.github.io/Transaction/?neighborid=${encodeURIComponent(neighborId)}`;
      const qrDataURL = await QRCode.toDataURL(url);

      const firstName = formData.firstName || '';
      const lastName = formData.lastName || '';
      const householdSize = parseInt(formData.householdSize || "1");

      let memberLines = "";
      for (let i = 1; i < householdSize; i++) {
        const fname = formData[`member${i}FirstName`] || '';
        const lname = formData[`member${i}LastName`] || '';
        if (fname || lname) {
          memberLines += `- ${fname} ${lname}\n`;
        }
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.addImage(qrDataURL, "PNG", 55, 20, 100, 100);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("Market Attendee QR Code", 105, 130, { align: "center" });

      let y = 150;
      doc.setFontSize(12);

      doc.setFont("helvetica", "bold");
      doc.text("Attendee Name:", 20, y);
      doc.setFont("helvetica", "normal");
      doc.text(`${firstName} ${lastName}`, 60, y);
      y += 10;

      doc.setFont("helvetica", "bold");
      doc.text("Attendee ID:", 20, y);
      doc.setFont("helvetica", "normal");
      doc.text(attendeeId.toString(), 60, y);
      y += 10;

      doc.setFont("helvetica", "bold");
      doc.text("Neighbor ID:", 20, y);
      doc.setFont("helvetica", "normal");
      doc.text(neighborId, 60, y);
      y += 10;

      if (householdSize > 1 && memberLines.trim()) {
        doc.setFont("helvetica", "bold");
        doc.text("Household Members:", 20, y);
        y += 10;
        doc.setFont("helvetica", "normal");
        const splitMembers = doc.splitTextToSize(memberLines.trim(), 170);
        doc.text(splitMembers, 25, y);
      }
	doc.setFont("helvetica", "bold");
        doc.text("Mobile Wallet URL:", 20, y);
	const walletUrl = `https://farmersmarket-hub.github.io/Mobile-Wallet/?neighborid=${encodeURIComponent(neighborId)}`;
        doc.setFont("helvetica", "normal");
        doc.text(walletUrl, 60, y);
        y += 10;

      doc.save(`QR_${attendeeId}.pdf`);

      return new Promise(resolve => {
	  const blob = doc.output("blob");
	  const reader = new FileReader();
	  reader.onloadend = () => resolve(reader.result.split(',')[1]);
	  reader.readAsDataURL(blob);
      });
    }
		
		function generateNeighborId(event) {
            event.preventDefault();
            
            const reachProgramMapping = {
                "Unknown": "0",
                "None": "010",
                "REACHing Us Farmers Market": "1",
                "PGL CSA": "2"
            };

            const vendorMapping = {
                "Unknown": "0",
                "None": "010",
                "PGL": "10.0",
                "Mr. Farms- Maxi Hernandez": "20.0",
                "Sofia Farm- Mohammad": "30.0",
                "Rohingya Burmese Farm- Ali Johar": "40.0",
                "Yoshi Berry - Ishmail Santos": "50.0"
            };

            const populationMapping = {
                "Unknown": "0",
                "None": "010",
                "Low-income": "100.0",
                "Immigrant": "200.0",
                "BIPOC": "300.0",
                "Low-income BIPOC": "400.0",
                "BIPOC Immigrant": "500.0"
            };

            let reachProgramId = document.getElementById("reachProgram").value;
            let vendorId = document.getElementById("registeringVendor").value;
			
            let reachPopElement = document.getElementById("reachPopulation");
	    const selectedOptions = Array.from(reachPopElement.selectedOptions).map(opt => opt.value);
            const populationIdBlock = selectedOptions.join("_"); // combine all values with underscore
			
            let neighborNumber = Math.floor(10000 + Math.random() * 90000);
            let dateField = document.getElementById("todayDate").value;
            
            let date = new Date(dateField + "T00:00:00"); // Fix timezone issue
            let formattedDate = ("0" + (date.getMonth() + 1)).slice(-2) + ("0" + date.getDate()).slice(-2) + date.getFullYear();

            let neighborId = `REACH-${reachProgramId}-${vendorId}-${populationIdBlock}-${neighborNumber}`;
			document.getElementById("neighborid").value = neighborId;
			document.getElementById("attendeeId").value = neighborNumber;
			
			const form = document.getElementById("registrationForm");
            const formData = new FormData(form);
		// Get nationality properly from multiselect
		const nationalitySelect = document.getElementById("nationality");
		const allNationalities = Array.from(nationalitySelect.selectedOptions).map(opt => opt.value);
		
		// Update FormData to include the full list as a single string (comma separated)
		formData.set("nationality", allNationalities.join(", "));

		// Get nationality properly from multiselect
		const reachPopulationSelect = document.getElementById("reachPopulation");
		const allReachPopulation = Array.from(reachPopulationSelect.selectedOptions).map(opt => opt.value);
		
		// Update FormData to include the full list as a single string (comma separated)
		formData.set("reachPopulation", allReachPopulation.join(", "));
			const data = {};
      			formData.forEach((value, key) => {
        		data[key] = value;
      		});
			generateQRCodePDF(neighborId, neighborNumber, data).then(base64pdf => {
        		data.qrPdfBase64 = base64pdf;
        		sendData(data);
      			});
			
		}
		
		function sendData(data) {
			
			let successMessage = document.getElementById("successMessage");
			successMessage.innerText = `Registration successful! Your Neighbor ID: ${data.neighborid}`;
			successMessage.style.display = "block";
			  
			document.getElementById("registrationForm").reset();
			window.scrollTo({ top: 0, behavior: 'smooth' });

			fetch('https://script.google.com/macros/s/AKfycbw6BXU-SR0efSVGPXU7AvgDz41ZmUPi40KGkkFTfwiVpom3-a1toNaHut6-7dkW-SMapw/exec', {
			  method: 'POST',
			  headers: {
				'Content-Type': 'text/plain;charset=utf-8',
			  },
			  body: JSON.stringify(data),
			})
			.then(response => response.text())
			.then(result => {
			  console.log('Success:', result);
			})
			.catch(error => {
			  console.error('Error:', error);
			  // Handle the error here
			});

			fetch('https://script.google.com/macros/s/AKfycbwxyecQCJFs0amb8vPWh_atRqCOkAqhB4Se1ic8TYgZHXmbB4YTLe6YjfBRxiHg4F52/exec', {
			  method: 'POST',
			  headers: {
				'Content-Type': 'text/plain;charset=utf-8',
			  },
			  body: JSON.stringify(data),
			})
			.then(response => response.text())
			.then(result => {
			  console.log('Success:', result);
									
			  setTimeout(function() {						
				successMessage.style.display = "none";
			  }, 5000);
			})
			.catch(error => {
			  console.error('Error:', error);
			  // Handle the error here
			});
		}
    </script>	
</body>
</html>
